<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ form_config.name }} - Enhanced Search Results</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/all.min.css">

    <style>
        /* Enhanced Dynamic Styles */
        body {
            background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);

        }

        .form-header h1 {
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Enhanced Card Styling */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 15px 15px 0 0;
            border: none;
        }

        /* Dynamic Address Cards */
        .address-card {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            margin: 8px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .address-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #007bff;
        }

        .address-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .address-card:hover::before {
            left: 100%;
        }

        .address-type {
            display: inline-block;
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .address-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .address-field {
            padding: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .address-field strong {
            display: block;
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .address-field span {
            font-weight: 600;
            color: #333;
        }

        /* Expandable Sections */
        .expandable-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .expandable-section.expanded {
            max-height: 500px;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #007bff;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            transition: color 0.3s;
        }

        .toggle-btn:hover {
            color: #0056b3;
        }

        .toggle-btn i {
            transition: transform 0.3s ease;
        }

        .toggle-btn.rotated i {
            transform: rotate(180deg);
        }

        /* Enhanced Table Styles */
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #resultsTable {
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        #resultsTable thead th {
            background: linear-gradient(135deg, #343a40, #495057) !important;
            color: white;
            border-bottom: 2px solid #454d55;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            padding: 12px 8px;
            font-weight: 600;
        }

        #resultsTable tbody tr {
            transition: all 0.3s ease;
        }

        #resultsTable tbody tr:hover {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Enhanced Field Value Display */
        .field-value {
            padding: 8px 12px;
            background: rgba(0,123,255,0.05);
            border-radius: 8px;
            border-left: 3px solid #007bff;
            margin: 4px 0;
            transition: all 0.2s ease;
        }

        .field-value:hover {
            background: rgba(0,123,255,0.1);
            transform: translateX(2px);
        }

        /* Dynamic Badge Styling */
        .badge-custom {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border-radius: 20px;
            padding: 6px 12px;
            margin: 2px;
            display: inline-block;
            transition: transform 0.2s ease;
        }

        .badge-custom:hover {
            transform: scale(1.05);
        }

        /* Animation Classes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }

        /* Enhanced Form Controls */
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
            transform: scale(1.02);
        }

        /* Enhanced Button Styles */
        .btn {
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
        }

        /* Enhanced Multi-Value Styling */
        .checkbox-enhanced-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .checkbox-values-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            border-radius: 10px;
        }

        .checkbox-operator-icon {
            border-radius: 0 10px 10px 0;
            background: linear-gradient(135deg, #6c757d, #495057);
            border-color: #6c757d;
            color: white;
            transition: all 0.3s ease;
        }

        .checkbox-operator-icon:hover {
            background: linear-gradient(135deg, #495057, #343a40);
            transform: scale(1.05);
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .form-container {
                padding: 10px;
            }

            .address-card {
                padding: 10px;
            }

            .address-details {
                grid-template-columns: 1fr;
            }

            #resultsTable {
                font-size: 0.8rem;
            }
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="form-container">
        <!-- Form Header -->
        <div class="form-header fade-in-up">
            <h2><i class="fas fa-search-location me-2"></i>{{ form_config.name }}</h2>
            <p class="mb-0">Advanced Search with Dynamic Results Display</p>
        </div>

        <!-- Search Form -->
        <div class="card mb-4 slide-in-right">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Search Filters</h5>
            </div>
            <div class="card-body">
                <form id="dynamicForm">
                    <div class="row">
                        {% for field_name, field_config in form_config.fields.items() %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {{ field_config.label or field_name }}
                                {% if field_config.required %}
                                <span class="text-danger">*</span>
                                {% endif %}
                            </label>

                            {% if field_config.inputType == 'text' %}
                            <input type="text" class="form-control" name="{{ field_name }}"
                                   placeholder="{{ field_config.placeholder or '' }}"
                                   {% if field_config.required %}required{% endif %}>

                            {% elif field_config.inputType == 'number' %}
                            <input type="number" class="form-control" name="{{ field_name }}"
                                   placeholder="{{ field_config.placeholder or '' }}"
                                   {% if field_config.required %}required{% endif %}>

                            {% elif field_config.inputType == 'number-range' %}
                            <div class="input-group">
                                <input type="number" class="form-control" name="{{ field_name }}_min"
                                       placeholder="Min"
                                       {% if field_config.required %}required{% endif %}>
                                <span class="input-group-text">to</span>
                                <input type="number" class="form-control" name="{{ field_name }}_max"
                                       placeholder="Max"
                                       {% if field_config.required %}required{% endif %}>
                            </div>

                            {% elif field_config.inputType == 'date' %}
                            <input type="date" class="form-control" name="{{ field_name }}"
                                   {% if field_config.required %}required{% endif %}>

                            {% elif field_config.inputType == 'date-range' %}
                            <div class="input-group">
                                <input type="date" class="form-control" name="{{ field_name }}_start"
                                       {% if field_config.required %}required{% endif %}>
                                <span class="input-group-text">to</span>
                                <input type="date" class="form-control" name="{{ field_name }}_end"
                                       {% if field_config.required %}required{% endif %}>
                            </div>

                            {% elif field_config.inputType == 'dropdown' %}
                            <select class="form-select dynamic-dropdown"
                                    name="{{ field_name }}"
                                    id="dropdown-{{ field_name }}"
                                    data-field-name="{{ field_name }}"
                                    data-source-index="{{ field_config.sourceIndex or '' }}"
                                    data-key-field="{{ field_config.keyField or '' }}"
                                    data-value-field="{{ field_config.valueField or '' }}"
                                    {% if field_config.required %}required{% endif %}>
                                <option value="">Loading options...</option>
                            </select>

                            {% elif field_config.inputType == 'checkbox' %}
                            <div class="checkbox-enhanced-container">
                                <div class="input-group">
                                    <input type="text" class="form-control checkbox-values-display"
                                           id="checkbox-values-{{ field_name }}"
                                           placeholder="Click icon to select values..."
                                           readonly>
                                    <button class="btn btn-outline-secondary checkbox-operator-icon"
                                            type="button"
                                            data-field-name="{{ field_name }}"
                                            data-source-index="{{ field_config.sourceIndex or '' }}"
                                            data-key-field="{{ field_config.keyField or '' }}"
                                            data-value-field="{{ field_config.valueField or '' }}"
                                            data-operator="{{ field_config.operator or 'AND' }}"
                                            data-selected-values="{{ field_config.selectedValues | tojson if field_config.selectedValues else '[]' }}"
                                            title="Configure multi-value selection">
                                        <i class="fas fa-cogs"></i>
                                    </button>
                                </div>
                                <input type="hidden" id="checkbox-selected-{{ field_name }}" name="{{ field_name }}">
                            </div>

                            {% elif field_config.inputType == 'radio' %}
                            <div class="radio-group">
                                {% for option in field_config.selectedValues or [] %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="{{ field_name }}"
                                           value="{{ option }}" {% if field_config.required %}required{% endif %}>
                                    <label class="form-check-label">{{ option }}</label>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-search me-2"></i>Search
                            <span class="loading-spinner" style="display: none;">
                                <i class="fas fa-spinner fa-spin ms-2"></i>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Enhanced Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Dynamic results will be inserted here -->
        </div>

        <!-- Dynamic Control Panel -->
        <div id="dynamicControls" class="card mt-4" style="display: none;">
            <div class="card-body">
                <h6><i class="fas fa-controls me-2"></i>Dynamic Controls</h6>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="toggleResultsView()">
                        <i class="fas fa-exchange-alt me-1"></i>Switch View
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshResults()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Multi-Value Selection Modal -->
<div class="modal fade" id="multiValueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-list-check me-2"></i>Select Values</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Logical Operator</label>
                    <select class="form-select" id="modalOperator">
                        <option value="AND">AND - All selected values must match</option>
                        <option value="OR">OR - Any selected value can match</option>
                        <option value="NOT">NOT - Exclude selected values</option>
                    </select>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllModalValues()">
                            <i class="fas fa-check-double me-1"></i>Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllModalValues()">
                            <i class="fas fa-times me-1"></i>Deselect All
                        </button>
                    </div>
                </div>
                <div id="modalValuesList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Values will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="applyModalSelection()">
                    <i class="fas fa-check me-1"></i>Apply Selection
                </button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/bootstrap.bundle.min.js"></script>

<script>
    // Global variables
    window.formConfig = {{ form_config | tojson }};
    let currentMultiValueField = null;
    let currentData = null;
    let currentView = 'dynamic'; // 'dynamic' or 'table'

    // Enhanced Results Display Function
    function displaySearchResults(result) {
        const resultsSection = document.getElementById('resultsSection');
        const controlsSection = document.getElementById('dynamicControls');

        if (!resultsSection) {
            console.error('Results section not found');
            return;
        }

        currentData = result;
        resultsSection.style.display = 'block';
        controlsSection.style.display = 'block';

        // Display results based on current view
        if (currentView === 'dynamic') {
            displayDynamicResults(result);
        } else {
            displayTableResults(result);
        }

        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }



    // Dynamic Results Display
    function displayDynamicResults_v1(result) {
        const resultsSection = document.getElementById('resultsSection');

        const resultsHTML = `
        <div class="card fade-in-up">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-search-plus me-2"></i>Dynamic Search Results
                </h5>
                <div>
                    <span class="badge bg-light text-dark fs-6">${result.total || 0} results</span>
                    <span class="badge bg-light text-dark fs-6 ms-2">${result.took || 0}ms</span>
                    <span class="badge bg-info fs-6 ms-2">Dynamic View</span>
                </div>
            </div>
            <div class="card-body">
                ${result.query ? createQueryInfoHTML(result.query) : ''}
                ${result.generated_questions ? createGeneratedQuestionsQueryInfoHTML(result.generated_questions) : ''}
                <div class="results-container">
                    ${result.results && result.results.length > 0 ?
            result.results.map((item, index) => `
                            <div class="card mb-3 result-card fade-in-up" style="animation-delay: ${index * 0.1}s">
                                <div class="card-header d-flex justify-content-between">
                                    <span class="fw-bold">
                                        <i class="fas fa-user me-2"></i>Result #${index + 1}
                                    </span>
                                    <div>
                                        <span class="badge bg-success">Score: ${item.score?.toFixed(3) || 'N/A'}</span>
                                        <span class="badge bg-info ms-1">ID: ${item.id || 'N/A'}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    ${formatResultDataDynamic(item.data, index)}
                                    ${item.highlight && Object.keys(item.highlight).length > 0 ? `
                                        <div class="mt-3">
                                            <h6><i class="fas fa-highlighter me-2"></i>Highlights:</h6>
                                            ${Object.entries(item.highlight).map(([field, highlights]) => `
                                                <div class="field-value">
                                                    <strong>${field}:</strong> ${highlights.join(', ')}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('') :
            '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No results found for your search criteria.</div>'
        }
                </div>
            </div>
        </div>
    `;

        resultsSection.innerHTML = resultsHTML;
    }

    // Enhanced Dynamic Data Formatting
    function formatResultDataDynamic(data, resultIndex) {
        if (!data || typeof data !== 'object') {
            return '<p class="text-muted">No data available</p>';
        }

        let html = '<div class="row">';

        for (const [key, value] of Object.entries(data)) {
            if (key === 'addresses' || key === 'address') {
                // Special handling for addresses with dynamic cards
                html += `
                <div class="col-12 mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <strong class="text-primary me-2">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            ${key.replace(/_/g, ' ')}:
                        </strong>
                        <button class="toggle-btn btn-sm" onclick="toggleAddresses(${resultIndex})">
                            <i class="fas fa-chevron-down"></i>
                            <span>${Array.isArray(value) ? value.length : (value ? 1 : 0)} address(es)</span>
                        </button>
                    </div>
                    <div class="expandable-section expanded" id="addresses-${resultIndex}">
                        ${formatAddressesDynamic(value, resultIndex)}
                    </div>
                </div>
            `;
            } else {
                // Enhanced field display for other fields
                html += `
                <div class="col-md-6 mb-3">
                    <div class="field-value">
                        <strong class="text-primary">${formatColumnHeader(key)}:</strong><br>
                        <span class="text-break">${formatFieldValueDynamic(value)}</span>
                    </div>
                </div>
            `;
            }
        }

        html += '</div>';
        return html;
    }

    // Dynamic Address Formatting
    function formatAddressesDynamic(addresses, resultIndex) {
        // Handle single address object
        if (!Array.isArray(addresses) && addresses && typeof addresses === 'object') {
            addresses = [addresses];
        }

        if (!Array.isArray(addresses) || addresses.length === 0) {
            return '<div class="text-muted">No addresses available</div>';
        }

        return addresses.map((address, addressIndex) => {
            const addressId = `address-${resultIndex}-${addressIndex}`;
            return `
            <div class="address-card" onclick="toggleAddressDetails('${addressId}')">
                <div class="address-type">
                    <i class="fas fa-home me-1"></i>
                    ${address.type || 'Address'}
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-bold text-primary">
                        ${formatAddressLine(address)}
                    </div>
                    <i class="fas fa-chevron-down toggle-icon" id="icon-${addressId}"></i>
                </div>
                <div class="expandable-section" id="${addressId}">
                    <div class="address-details">
                        ${Object.entries(address)
                .filter(([key]) => key !== 'type')
                .map(([key, value]) => `
                            <div class="address-field">
                                <strong>${formatColumnHeader(key)}</strong>
                                <span>${value || 'N/A'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }

    // Format address line for display
    function formatAddressLine(address) {
        const parts = [];
        if (address.city) parts.push(address.city);
        if (address.state) parts.push(address.state);
        if (address.pincode || address.postal_code || address.zip) {
            parts.push(address.pincode || address.postal_code || address.zip);
        }
        if (address.country) parts.push(address.country);
        return parts.join(', ') || 'Address details';
    }

    // Enhanced Field Value Formatting
    function formatFieldValueDynamic(value) {
        if (value === null || value === undefined) {
            return '<em class="text-muted">N/A</em>';
        }

        if (Array.isArray(value)) {
            if (value.length === 0) {
                return '<em class="text-muted">Empty</em>';
            }
            if (value.length <= 3) {
                return value.map(v => `<span class="badge-custom">${escapeHtml(String(v))}</span>`).join(' ');
            } else {
                return `
                ${value.slice(0, 3).map(v => `<span class="badge-custom">${escapeHtml(String(v))}</span>`).join(' ')}
                <span class="text-muted">+${value.length - 3} more</span>
            `;
            }
        }

        if (typeof value === 'object') {
            return `
            <button class="btn btn-sm btn-outline-info" onclick="showObjectModal('${escapeHtml(JSON.stringify(value))}')">
                <i class="fas fa-eye"></i> View Object
            </button>
        `;
        }

        // Boolean formatting with icons
        if (typeof value === 'boolean') {
            return `<i class="fas fa-${value ? 'check text-success' : 'times text-danger'}"></i> ${value}`;
        }

        // Enhanced date formatting
        if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}/.test(value)) {
            try {
                const date = new Date(value);
                return `<i class="fas fa-calendar me-1"></i>${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            } catch (e) {
                return escapeHtml(String(value));
            }
        }

        // URL formatting
        if (typeof value === 'string' && /^https?:\/\//.test(value)) {
            return `<a href="${value}" target="_blank" class="text-decoration-none"><i class="fas fa-external-link-alt me-1"></i>${truncateText(value, 30)}</a>`;
        }

        // Email formatting
        if (typeof value === 'string' && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
            return `<a href="mailto:${value}" class="text-decoration-none"><i class="fas fa-envelope me-1"></i>${value}</a>`;
        }

        // Long text truncation
        const stringValue = String(value);
        if (stringValue.length > 50) {
            return `
            <span class="text-truncate d-inline-block" style="max-width: 200px;" title="${escapeHtml(stringValue)}">
                ${escapeHtml(stringValue)}
            </span>
        `;
        }

        return escapeHtml(stringValue);
    }

    // Interactive Functions
    function toggleAddresses(resultIndex) {
        const section = document.getElementById(`addresses-${resultIndex}`);
        section.classList.toggle('expanded');
    }

    function toggleAddressDetails(addressId) {
        const section = document.getElementById(addressId);
        const icon = document.getElementById(`icon-${addressId}`);

        section.classList.toggle('expanded');
        if (icon) {
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        }
    }

    function toggleResultsView() {
        if (currentData) {
            currentView = currentView === 'dynamic' ? 'table' : 'dynamic';
            displaySearchResults(currentData);

            showNotification(`Switched to ${currentView} view`, 'info');
        }
    }

    function refreshResults() {
        if (currentData) {
            const section = document.getElementById('resultsSection');
            section.style.opacity = '0.5';
            section.classList.add('loading-skeleton');

            setTimeout(() => {
                section.style.opacity = '1';
                section.classList.remove('loading-skeleton');
                displaySearchResults(currentData);
                showNotification('Results refreshed', 'success');
            }, 1000);
        }
    }

    function exportResults() {
        if (currentData && currentData.results) {
            const dataStr = JSON.stringify(currentData.results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `search-results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification('Results exported successfully', 'success');
        }
    }

    // Table Results Display (fallback)
    function displayTableResults(result) {
        // Implementation for table view (keep existing table code)
        const resultsSection = document.getElementById('resultsSection');

        const tableHTML = `
        <div class="card fade-in-up">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Table Search Results
                </h5>
                <div>
                    <span class="badge bg-light text-dark fs-6">${result.total || 0} results</span>
                    <span class="badge bg-light text-dark fs-6 ms-2">${result.took || 0}ms</span>
                    <span class="badge bg-warning fs-6 ms-2">Table View</span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Score</th>
                                <th>ID</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.results && result.results.length > 0 ?
            result.results.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><span class="badge bg-success">${item.score?.toFixed(3) || 'N/A'}</span></td>
                                    <td><small class="font-monospace">${item.id || 'N/A'}</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="showObjectModal('${escapeHtml(JSON.stringify(item.data))}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            `).join('') :
            '<tr><td colspan="4" class="text-center text-muted">No results found</td></tr>'
        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

        resultsSection.innerHTML = tableHTML;
    }

    // Query Info HTML
    function createQueryInfoHTML(query) {
        return `
        <div class="alert alert-info">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-code me-2"></i>Elasticsearch Query</h6>
                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse"
                        data-bs-target="#queryCollapse" aria-expanded="false">
                    <i class="fas fa-eye"></i> View Query
                </button>
            </div>
            <div class="collapse mt-2" id="queryCollapse">
                <pre class="bg-dark text-light p-3 rounded"><code>${JSON.stringify(query, null, 2)}</code></pre>
            </div>
        </div>
    `;
    }

    function createGeneratedQuestionsQueryInfoHTML(query) {
        const questionsList = query.map((q, i) => `<li>${q.question}</li>`).join("");
        return `
        <div class="alert alert-info">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-code me-2"></i>Generated Questions</h6>
                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse"
                        data-bs-target="#queryCollapsev2" aria-expanded="false">
                    <i class="fas fa-eye"></i> View Questions
                </button>
            </div>
            <div class="collapse mt-2" id="queryCollapsev2">
                <ul class="mb-0 ps-4">${questionsList}</ul>
            </div>
        </div>
    `;
    }

    // Utility Functions
    function formatColumnHeader(column) {
        return column
            .replace(/_/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
    }

    function truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showObjectModal(jsonString) {
        try {
            const obj = JSON.parse(jsonString);
            const modalHTML = `
            <div class="modal fade" id="objectModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-code me-2"></i>Object Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code>${JSON.stringify(obj, null, 2)}</code></pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal
            const existingModal = document.getElementById('objectModal');
            if (existingModal) existingModal.remove();

            // Add and show new modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('objectModal'));
            modal.show();
        } catch (error) {
            showNotification('Failed to display object data', 'error');
        }
    }

    function showNotification(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show notification`;
        alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }

    // Form Initialization and Handling (keeping existing functionality)
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Enhanced form initialized');
        initializeDynamicForm();
        setupFormSubmission();
    });

    function initializeDynamicForm() {
        // Initialize dropdowns
        document.querySelectorAll('.dynamic-dropdown').forEach(dropdown => {
            const fieldName = dropdown.dataset.fieldName;
            const fieldConfig = window.formConfig.fields[fieldName];

            if (fieldConfig && fieldConfig.keyField) {
                loadDropdownValues(fieldName, fieldConfig);
            } else {
                loadStaticDropdownValues(fieldName);
            }
        });

        // Initialize enhanced checkbox buttons
        document.querySelectorAll('.checkbox-operator-icon').forEach(button => {
            button.addEventListener('click', function() {
                const fieldName = this.dataset.fieldName;
                const fieldConfig = window.formConfig.fields[fieldName];
                showMultiValueModal(fieldName, fieldConfig);
            });
        });
    }

    function setupFormSubmission() {
        const form = document.getElementById('dynamicForm');
        if (!form) return;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = form.querySelector('button[type="submit"]');
            const loadingSpinner = submitBtn.querySelector('.loading-spinner');
            const originalText = submitBtn.innerHTML;

            try {
                // Show loading state
                submitBtn.disabled = true;
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'inline-block';
                } else {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Searching...';
                }

                // Capture and submit form data
                const formData = captureAllFormParameters(form);
                const validation = validateFormData(formData);

                if (!validation.isValid) {
                    throw new Error(validation.message);
                }

                const result = await submitFormToAPI(formData);
                displaySearchResults(result);
                showNotification('Search completed successfully', 'success');

            } catch (error) {
                console.error('Form submission error:', error);
                showNotification('Search failed: ' + error.message, 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                } else {
                    submitBtn.innerHTML = originalText;
                }
            }
        });
    }

    // Keep all existing form handling functions (captureAllFormParameters, validateFormData, submitFormToAPI, etc.)
    function captureAllFormParameters(form) {
        const formData = {};
        const rangeBuffers = {};
        const formElements = form.elements;

        for (let i = 0; i < formElements.length; i++) {
            const element = formElements[i];

            if (!element.name || element.disabled ||
                element.type === 'submit' || element.type === 'button') {
                continue;
            }

            const fieldName = element.name;

            // Handle range inputs (number/date range)
            if (/(?:_min|_max|_start|_end)$/.test(fieldName)) {
                const base = fieldName.replace(/_(min|max|start|end)$/, '');
                const bound = /_(min|start)$/.test(fieldName) ? 'gte' : 'lte';

                if (!rangeBuffers[base]) rangeBuffers[base] = {};
                if (element.value.trim()) {
                    rangeBuffers[base][bound] = element.value.trim();
                }
                continue;
            }

            switch (element.type) {
                case 'text':
                case 'number':
                case 'date':
                case 'email':
                case 'tel':
                    if (element.value.trim()) {
                        formData[fieldName] = element.value.trim();
                    }
                    break;

                case 'select-one':
                    if (element.value) {
                        formData[fieldName] = element.value;
                    }
                    break;

                case 'checkbox':
                    if (element.checked) {
                        if (!formData[fieldName]) {
                            formData[fieldName] = [];
                        }
                        if (Array.isArray(formData[fieldName])) {
                            formData[fieldName].push(element.value);
                        } else {
                            formData[fieldName] = [formData[fieldName], element.value];
                        }
                    }
                    break;

                case 'radio':
                    if (element.checked) {
                        formData[fieldName] = element.value;
                    }
                    break;

                case 'hidden':
                    if (element.id.startsWith('checkbox-selected-') && element.value) {
                        try {
                            const checkboxData = JSON.parse(element.value);
                            formData[fieldName] = {
                                type: 'multi_value',
                                operator: checkboxData.operator || 'AND',
                                values: checkboxData.values || []
                            };
                        } catch (error) {
                            if (element.value.trim()) {
                                formData[fieldName] = element.value.trim();
                            }
                        }
                    }
                    break;
            }
        }

        // Merge range buffers into form data
        Object.entries(rangeBuffers).forEach(([key, value]) => {
            if (Object.keys(value).length > 0) {
                formData[key] = value;
            }
        });

        return {
            fields: formData,
            metadata: {
                formUrl: window.location.pathname.split('/').pop(),
                timestamp: new Date().toISOString(),
                formName: window.formConfig.name,
                fieldCount: Object.keys(formData).length
            }
        };
    }

    function validateFormData(data) {
        const { fields } = data;

        for (const [fieldName, fieldConfig] of Object.entries(window.formConfig.fields)) {
            if (fieldConfig.required) {
                const value = fields[fieldName];

                if (!value || value === '' ||
                    (Array.isArray(value) && value.length === 0) ||
                    (typeof value === 'object' && value.type === 'multi_value' && value.values.length === 0) ||
                    (typeof value === 'object' && !Array.isArray(value) &&
                        !value.gte && !value.lte)) {

                    return {
                        isValid: false,
                        message: `${fieldConfig.label || fieldName} is required`
                    };
                }
            }
        }

        return { isValid: true };
    }

    async function submitFormToAPI(formData) {
        const { metadata } = formData;
        const apiEndpoint = `/submit-form/${metadata.formUrl}`;

        const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Unknown server error');
        }

        return result;
    }

    // Multi-value modal functions
    async function loadDropdownValues(fieldName, fieldConfig) {
        const dropdown = document.getElementById(`dropdown-${fieldName}`);
        if (!dropdown) return;

        try {
            dropdown.innerHTML = '<option value="">Loading...</option>';
            dropdown.disabled = true;
            const index_name = window.formConfig.index_name;
            const response = await fetch(
                `/field-values/${window.formConfig.environment}/${index_name}/${fieldConfig.keyField}`
            );

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    dropdown.innerHTML = '<option value="">Select option...</option>';
                    result.values.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.value;
                        option.textContent = item.count ?
                            `${item.value} (${item.count})` : item.value;
                        dropdown.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Error loading dropdown values:', error);
            dropdown.innerHTML = '<option value="">Error loading options</option>';
        } finally {
            dropdown.disabled = false;
        }
    }

    function loadStaticDropdownValues(fieldName) {
        const dropdown = document.getElementById(`dropdown-${fieldName}`);
        const fieldConfig = window.formConfig.fields[fieldName];

        if (!dropdown || !fieldConfig) return;

        dropdown.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = `Select ${fieldConfig.label || fieldName}...`;
        dropdown.appendChild(defaultOption);

        if (fieldConfig.selectedValues && fieldConfig.selectedValues.length > 0) {
            fieldConfig.selectedValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                dropdown.appendChild(option);
            });
        }
    }

    async function showMultiValueModal(fieldName, fieldConfig) {
        currentMultiValueField = fieldName;
        document.getElementById('modalOperator').value = fieldConfig.operator || 'AND';
        await loadModalValues(fieldConfig);
        const modal = new bootstrap.Modal(document.getElementById('multiValueModal'));
        modal.show();
    }

    async function loadModalValues(fieldConfig) {
        const valuesList = document.getElementById('modalValuesList');

        if (!fieldConfig.sourceIndex || !fieldConfig.keyField) {
            valuesList.innerHTML = '<div class="alert alert-warning">Source not configured</div>';
            return;
        }

        try {
            valuesList.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading values...</div>';

            const response = await fetch(
                `/field-values/${window.formConfig.environment}/${fieldConfig.sourceIndex}/${fieldConfig.keyField}`
            );

            const result = await response.json();

            if (result.success) {
                populateModalValues(result.values, fieldConfig.selectedValues || []);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            console.error('Error loading modal values:', error);
            valuesList.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    function populateModalValues(values, selectedValues) {
        const valuesList = document.getElementById('modalValuesList');
        valuesList.innerHTML = '';

        values.forEach((valueObj, index) => {
            const isSelected = selectedValues.includes(valueObj.value);

            const div = document.createElement('div');
            div.className = 'form-check mb-2';
            div.innerHTML = `
            <input class="form-check-input modal-value-checkbox"
                   type="checkbox"
                   value="${valueObj.value}"
                   id="modal-value-${index}"
                   ${isSelected ? 'checked' : ''}>
            <label class="form-check-label" for="modal-value-${index}">
                ${valueObj.value} ${valueObj.count ? `<span class="badge bg-secondary">${valueObj.count}</span>` : ''}
            </label>
        `;
            valuesList.appendChild(div);
        });
    }

    function applyModalSelection() {
        if (!currentMultiValueField) return;

        const selectedValues = [];
        document.querySelectorAll('.modal-value-checkbox:checked').forEach(checkbox => {
            selectedValues.push(checkbox.value);
        });

        const operator = document.getElementById('modalOperator').value;

        if (selectedValues.length === 0) {
            showNotification('Please select at least one value', 'warning');
            return;
        }

        // Update display
        const displayField = document.getElementById(`checkbox-values-${currentMultiValueField}`);
        const hiddenField = document.getElementById(`checkbox-selected-${currentMultiValueField}`);

        if (displayField && hiddenField) {
            const operatorSymbol = operator === 'AND' ? ' AND ' : operator === 'OR' ? ' OR ' : ' NOT ';
            displayField.value = `${operator}: ${selectedValues.join(operatorSymbol)}`;

            hiddenField.value = JSON.stringify({
                operator: operator,
                values: selectedValues
            });
        }

        // Force close modal
        const modalElement = document.getElementById('multiValueModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();

        showNotification(`Applied ${selectedValues.length} values with ${operator} operator`, 'success');
    }

    function selectAllModalValues() {
        document.querySelectorAll('.modal-value-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
    }

    function deselectAllModalValues() {
        document.querySelectorAll('.modal-value-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    }






    function displayDynamicResults(result) {
        const resultsSection = document.getElementById('resultsSection');

        // Store results globally for detail views
        window.currentSearchResults = result.results || [];

        const resultsHTML = `
    <div class="card fade-in-up">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-search-plus me-2"></i>Dynamic Search Results
            </h5>
            <div>
                <span class="badge bg-light text-dark fs-6">${result.total || 0} results</span>
                <span class="badge bg-light text-dark fs-6 ms-2">${result.took || 0}ms</span>
                <span class="badge bg-info fs-6 ms-2">Dynamic Table</span>
            </div>
        </div>
        <div class="card-body">
            ${result.query ? createQueryInfoHTML(result.query) : ''}
            ${result.generated_questions ? createGeneratedQuestionsQueryInfoHTML(result.generated_questions) : ''}

            <div class="results-container">
                ${result.results && result.results.length > 0 ?
            createDynamicTable(result.results) :
            `<div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No results found for your search criteria.
                    </div>`
        }
            </div>
        </div>
    </div>
`;

        resultsSection.innerHTML = resultsHTML;
        addDynamicTableEventListeners();
    }

    function createDynamicTable(results) {
        if (!results || results.length === 0) return '';

        // Analyze data structure to determine columns (only top-level fields)
        const columns = analyzeDataStructure(results);

        // Check if there are nested fields to show
        const hasNestedData = results.some(result =>
                result.data && Object.values(result.data).some(value =>
                    Array.isArray(value) || (typeof value === 'object' && value !== null)
                )
        );

        return `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th scope="col" style="width: 60px;">
                            <i class="fas fa-hashtag"></i>
                        </th>
                        <th scope="col" style="width: 80px;">
                            <i class="fas fa-star me-1"></i>Score
                        </th>
                        ${columns.map(col => `
                            <th scope="col" style="min-width: ${getColumnWidth(col)}px;">
                                <i class="${getColumnIcon(col)} me-1"></i>
                                ${formatColumnHeader(col)}
                            </th>
                        `).join('')}
                        ${hasNestedData ? `
                            <th scope="col" style="width: 120px;">
                                <i class="fas fa-layer-group me-1"></i>Nested Data
                            </th>
                        ` : ''}
                        <th scope="col" style="width: 100px;">
                            <i class="fas fa-eye me-1"></i>Actions
                        </th>
                    </tr>
                </thead>
                <tbody>
                    ${results.map((item, index) => createDynamicTableRow(item, index, columns, hasNestedData)).join('')}
                </tbody>
            </table>
        </div>
    `;
    }

    function analyzeDataStructure(results) {
        const allColumns = new Set();
        const columnTypes = {};
        const nestedColumns = new Set();

        // Analyze all results to find all possible columns
        results.forEach(result => {
            if (result.data) {
                analyzeObject(result.data, '', allColumns, columnTypes, nestedColumns, 1, 0); // Only 1 level deep for main table
            }
        });

        // Convert to array and filter out nested fields for main table
        const columns = Array.from(allColumns)
            .filter(col => {
                // Skip nested array/object fields in main table
                if (nestedColumns.has(col)) return false;

                // Skip deeply nested fields (containing dots)
                if (col.includes('.')) return false;

                return true;
            })
            .sort((a, b) => {
                // Sort alphabetically
                return a.localeCompare(b);
            });

        return columns.map(col => ({
            key: col,
            type: columnTypes[col] || 'string',
            isNested: false // Only showing top-level fields in main table
        }));
    }

    function analyzeObject(obj, prefix, allColumns, columnTypes, nestedColumns, maxDepth = 1, currentDepth = 0) {
        if (!obj || typeof obj !== 'object' || currentDepth >= maxDepth) return;

        Object.keys(obj).forEach(key => {
            const fullKey = prefix ? `${prefix}.${key}` : key;
            const value = obj[key];

            if (Array.isArray(value)) {
                // Mark as nested but don't include in main table columns
                if (currentDepth === 0) { // Only for top-level arrays
                    allColumns.add(fullKey);
                    columnTypes[fullKey] = 'array';
                    nestedColumns.add(fullKey);
                }
            } else if (value && typeof value === 'object') {
                // Mark as nested but don't include in main table columns
                if (currentDepth === 0) { // Only for top-level objects
                    allColumns.add(fullKey);
                    columnTypes[fullKey] = 'object';
                    nestedColumns.add(fullKey);
                }
            } else {
                // Only include primitive values in main table
                if (currentDepth === 0) { // Only top-level primitives
                    allColumns.add(fullKey);
                    columnTypes[fullKey] = typeof value;
                }
            }
        });
    }

    function createDynamicTableRow(item, index, columns, hasNestedData) {
        const data = item.data || {};

        // Find nested data in this record
        const nestedFields = Object.entries(data).filter(([key, value]) =>
            Array.isArray(value) || (typeof value === 'object' && value !== null)
        );

        return `
        <tr class="fade-in-up" style="animation-delay: ${index * 0.05}s">
            <td>
                <span class="badge bg-secondary">${index + 1}</span>
            </td>
            <td>
                <span class="badge bg-success">${item.score?.toFixed(3) || 'N/A'}</span>
            </td>
            ${columns.map(col => `
                <td>
                    ${formatCellValue(getNestedValue(data, col.key), col.type, col.key)}
                </td>
            `).join('')}
            ${hasNestedData ? `
                <td>
                    ${createNestedDataSummary(nestedFields, index)}
                </td>
            ` : ''}
            <td>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary"
                            onclick="viewDetails('${item.id}', ${index})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info"
                            onclick="toggleRowExpansion(${index})" title="Expand/Collapse">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </td>
        </tr>
        <tr id="expanded-row-${index}" class="expanded-row" style="display: none;">
            <td colspan="${columns.length + (hasNestedData ? 4 : 3)}">
                <div class="p-3 bg-light">
                    <h6><i class="fas fa-info-circle me-2"></i>Detailed View</h6>
                    ${createDetailedView(data)}
                </div>
            </td>
        </tr>
    `;
    }

    function createNestedDataSummary(nestedFields, rowIndex) {
        if (nestedFields.length === 0) {
            return '<span class="text-muted">None</span>';
        }

        return `
        <div class="d-flex flex-wrap gap-1">
            ${nestedFields.map(([key, value]) => {
            const isArray = Array.isArray(value);
            const count = isArray ? value.length : Object.keys(value || {}).length;
            const badgeClass = isArray ? 'bg-info' : 'bg-secondary';
            const icon = isArray ? 'fas fa-list' : 'fas fa-cube';

            return `
                    <button class="btn btn-sm btn-outline-${isArray ? 'info' : 'secondary'}"
                            onclick="${isArray ? 'showArrayDetails' : 'showObjectDetails'}('${key}', ${JSON.stringify(value).replace(/"/g, '&quot;')})"
                            title="View ${formatColumnHeader({key})}">
                        <i class="${icon} me-1"></i>
                        <span class="badge ${badgeClass}">${count}</span>
                    </button>
                `;
        }).join('')}
        </div>
    `;
    }

    function getNestedValue(obj, path) {
        return path.split('.').reduce((current, key) => {
            return current && current[key] !== undefined ? current[key] : null;
        }, obj);
    }

    function formatCellValue(value, type, key) {
        if (value === null || value === undefined) {
            return '<span class="text-muted">N/A</span>';
        }

        switch (type) {
            case 'array':
                if (Array.isArray(value)) {
                    return `
                    <span class="badge bg-info">${value.length} items</span>
                    <button class="btn btn-sm btn-outline-secondary ms-1"
                            onclick="showArrayDetails('${key}', ${JSON.stringify(value).replace(/"/g, '&quot;')})">
                        <i class="fas fa-list"></i>
                    </button>
                `;
                }
                return '<span class="text-muted">Empty</span>';

            case 'object':
                if (typeof value === 'object') {
                    const keys = Object.keys(value);
                    return `
                    <span class="badge bg-secondary">${keys.length} fields</span>
                    <button class="btn btn-sm btn-outline-secondary ms-1"
                            onclick="showObjectDetails('${key}', ${JSON.stringify(value).replace(/"/g, '&quot;')})">
                        <i class="fas fa-expand"></i>
                    </button>
                `;
                }
                return formatPrimitiveValue(value, key);

            case 'number':
                return formatNumber(value);

            case 'boolean':
                return `<span class="badge ${value ? 'bg-success' : 'bg-danger'}">${value}</span>`;

            case 'string':
            default:
                return formatPrimitiveValue(value, key);
        }
    }

    function formatPrimitiveValue(value, key) {
        const strValue = String(value);

        // Email detection
        if (key.toLowerCase().includes('email') || strValue.includes('@')) {
            return `<a href="mailto:${strValue}" class="text-decoration-none">${strValue}</a>`;
        }

        // Phone detection
        if (key.toLowerCase().includes('phone') || /^[\+\-\(\)\d\s\-\.x]+$/.test(strValue)) {
            return `<a href="tel:${strValue}" class="text-decoration-none">${strValue}</a>`;
        }

        // Date detection
        if (key.toLowerCase().includes('date') || key.toLowerCase().includes('time')) {
            return formatDate(strValue);
        }

        // URL detection
        if (strValue.startsWith('http://') || strValue.startsWith('https://')) {
            return `<a href="${strValue}" target="_blank" class="text-decoration-none">${strValue}</a>`;
        }

        // Status-like fields
        if (key.toLowerCase().includes('status') || key.toLowerCase().includes('consent')) {
            return `<span class="badge ${getStatusBadge(strValue)}">${strValue}</span>`;
        }

        // Long text truncation
        if (strValue.length > 50) {
            return `
            <span title="${strValue}">
                ${strValue.substring(0, 47)}...
            </span>
        `;
        }

        return strValue;
    }

    function formatNumber(value) {
        const num = Number(value);
        if (isNaN(num)) return value;

        // Format large numbers with commas
        if (num >= 1000) {
            return num.toLocaleString();
        }

        return num;
    }

    function formatDate(dateStr) {
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;

            return date.toLocaleDateString() + (dateStr.includes('T') ? ' ' + date.toLocaleTimeString() : '');
        } catch (e) {
            return dateStr;
        }
    }

    function getStatusBadge(status) {
        const statusLower = String(status).toLowerCase();
        if (statusLower.includes('active') || statusLower === 'y' || statusLower === 'true') return 'bg-success';
        if (statusLower.includes('inactive') || statusLower.includes('suspended') || statusLower === 'n' || statusLower === 'false') return 'bg-danger';
        if (statusLower.includes('pending') || statusLower.includes('partial')) return 'bg-warning';
        if (statusLower.includes('premium')) return 'bg-primary';
        return 'bg-secondary';
    }

    function formatColumnHeader(column) {
        return column.key
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ')
            .replace(/\./g, ' › ');
    }

    function getColumnIcon(column) {
        const key = column.key.toLowerCase();
        if (key.includes('email')) return 'fas fa-envelope';
        if (key.includes('phone')) return 'fas fa-phone';
        if (key.includes('address')) return 'fas fa-map-marker-alt';
        if (key.includes('date') || key.includes('time')) return 'fas fa-calendar';
        if (key.includes('status')) return 'fas fa-flag';
        if (key.includes('order')) return 'fas fa-shopping-cart';
        if (key.includes('spent') || key.includes('price') || key.includes('amount')) return 'fas fa-dollar-sign';
        if (key.includes('preference')) return 'fas fa-cog';
        if (key.includes('name')) return 'fas fa-user';
        if (key.includes('id')) return 'fas fa-hashtag';
        if (column.type === 'array') return 'fas fa-list';
        if (column.type === 'object') return 'fas fa-cube';
        if (column.type === 'number') return 'fas fa-calculator';
        if (column.type === 'boolean') return 'fas fa-toggle-on';
        return 'fas fa-text-height';
    }

    function getColumnWidth(column) {
        const key = column.key.toLowerCase();
        if (key.includes('id')) return 80;
        if (key.includes('email')) return 200;
        if (key.includes('phone')) return 150;
        if (key.includes('name')) return 120;
        if (key.includes('address')) return 200;
        if (key.includes('date')) return 120;
        if (column.type === 'array' || column.type === 'object') return 120;
        return 100;
    }

    function createDetailedView(data) {
        // Separate top-level primitive fields from nested data
        const primitiveFields = [];
        const nestedFields = [];

        Object.entries(data).forEach(([key, value]) => {
            if (Array.isArray(value) || (typeof value === 'object' && value !== null)) {
                nestedFields.push([key, value]);
            } else {
                primitiveFields.push([key, value]);
            }
        });

        return `
        <div class="container-fluid">
            ${primitiveFields.length > 0 ? `
                <div class="row mb-3">
                    <div class="col-12">
                        <h6 class="text-muted mb-2">Basic Information</h6>
                        <div class="row">
                            ${primitiveFields.map(([key, value]) => `
                                <div class="col-md-6 col-lg-4 mb-2">
                                    <strong>${formatColumnHeader({key})}:</strong><br>
                                    <span class="text-muted">${formatCellValue(value, typeof value, key)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}

            ${nestedFields.length > 0 ? `
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-muted mb-2">Nested Data</h6>
                        <div class="row">
                            ${nestedFields.map(([key, value]) => {
            const isArray = Array.isArray(value);
            const count = isArray ? value.length : Object.keys(value || {}).length;
            const icon = isArray ? 'fas fa-list' : 'fas fa-cube';
            const badgeClass = isArray ? 'bg-info' : 'bg-secondary';

            return `
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="${icon} me-2"></i>
                                                    ${formatColumnHeader({key})}
                                                </h6>
                                                <p class="card-text">
                                                    <span class="badge ${badgeClass} fs-6">${count} ${isArray ? 'items' : 'fields'}</span>
                                                </p>
                                                <button class="btn btn-sm btn-outline-primary"
                                                        onclick="${isArray ? 'showArrayDetails' : 'showObjectDetails'}('${key}', ${JSON.stringify(value).replace(/"/g, '&quot;')})">
                                                    <i class="fas fa-expand-alt me-1"></i>
                                                    View ${isArray ? 'Array' : 'Object'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
        }).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    }

    // Event handlers
    function addDynamicTableEventListeners() {
        // Create modal container if it doesn't exist
        if (!document.getElementById('dynamicModal')) {
            const modalHTML = `
            <div class="modal fade" id="dynamicModal" tabindex="-1" aria-labelledby="dynamicModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="dynamicModalLabel">Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="dynamicModalBody">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="exportData">
                                <i class="fas fa-download me-2"></i>Export JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Add export functionality
            document.getElementById('exportData').addEventListener('click', exportModalData);
        }
    }

    function viewDetails(id, index) {
        // Get the current results data (assuming it's stored globally or can be accessed)
        const results = window.currentSearchResults || [];
        const item = results[index];

        if (!item) {
            alert('Item not found');
            return;
        }

        const modalTitle = document.getElementById('dynamicModalLabel');
        const modalBody = document.getElementById('dynamicModalBody');

        modalTitle.innerHTML = `<i class="fas fa-user me-2"></i>Record Details - ID: ${id}`;

        modalBody.innerHTML = `
        <div class="container-fluid">
            <!-- Summary Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Summary</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Record ID:</strong><br>
                            <span class="badge bg-info fs-6">${id}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Search Score:</strong><br>
                            <span class="badge bg-success fs-6">${item.score?.toFixed(4) || 'N/A'}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Index Position:</strong><br>
                            <span class="badge bg-secondary fs-6">${index + 1}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Data Fields:</strong><br>
                            <span class="badge bg-warning text-dark fs-6">${Object.keys(item.data || {}).length}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Data -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-database me-2"></i>Complete Data Structure</h6>
                </div>
                <div class="card-body">
                    ${createDetailedDataView(item.data || {})}
                </div>
            </div>

            <!-- Highlights Section -->
            ${item.highlight && Object.keys(item.highlight).length > 0 ? `
                <div class="card mt-4">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-highlighter me-2"></i>Search Highlights</h6>
                    </div>
                    <div class="card-body">
                        ${Object.entries(item.highlight).map(([field, highlights]) => `
                            <div class="mb-2">
                                <strong>${formatColumnHeader({key: field})}:</strong><br>
                                ${highlights.map(h => `<span class="badge bg-warning text-dark me-1">${h}</span>`).join('')}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `;

        // Store current data for export
        window.currentModalData = item;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('dynamicModal'));
        modal.show();
    }

    function toggleRowExpansion(index) {
        const expandedRow = document.getElementById(`expanded-row-${index}`);
        const toggleButton = document.querySelector(`button[onclick="toggleRowExpansion(${index})"] i`);

        if (expandedRow.style.display === 'none') {
            expandedRow.style.display = 'table-row';
            toggleButton.className = 'fas fa-chevron-up';
        } else {
            expandedRow.style.display = 'none';
            toggleButton.className = 'fas fa-chevron-down';
        }
    }

    function showArrayDetails(key, arrayData) {
        try {
            const data = typeof arrayData === 'string' ? JSON.parse(arrayData) : arrayData;

            const modalTitle = document.getElementById('dynamicModalLabel');
            const modalBody = document.getElementById('dynamicModalBody');

            modalTitle.innerHTML = `<i class="fas fa-list me-2"></i>Array Details - ${formatColumnHeader({key})}`;

            modalBody.innerHTML = `
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-list me-2"></i>${formatColumnHeader({key})}</h6>
                        <span class="badge bg-info">${data.length} items</span>
                    </div>
                    <div class="card-body">
                        ${data.length === 0 ?
                '<div class="alert alert-info">This array is empty.</div>' :
                createArrayView(data, key)
            }
                    </div>
                </div>
            </div>
        `;

            // Store current data for export
            window.currentModalData = {[key]: data};

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('dynamicModal'));
            modal.show();

        } catch (error) {
            console.error('Error parsing array data:', error);
            alert('Error displaying array data');
        }
    }

    function showObjectDetails(key, objectData) {
        try {
            const data = typeof objectData === 'string' ? JSON.parse(objectData) : objectData;

            const modalTitle = document.getElementById('dynamicModalLabel');
            const modalBody = document.getElementById('dynamicModalBody');

            modalTitle.innerHTML = `<i class="fas fa-cube me-2"></i>Object Details - ${formatColumnHeader({key})}`;

            modalBody.innerHTML = `
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-cube me-2"></i>${formatColumnHeader({key})}</h6>
                        <span class="badge bg-secondary">${Object.keys(data).length} fields</span>
                    </div>
                    <div class="card-body">
                        ${Object.keys(data).length === 0 ?
                '<div class="alert alert-info">This object is empty.</div>' :
                createObjectView(data, key)
            }
                    </div>
                </div>
            </div>
        `;

            // Store current data for export
            window.currentModalData = {[key]: data};

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('dynamicModal'));
            modal.show();

        } catch (error) {
            console.error('Error parsing object data:', error);
            alert('Error displaying object data');
        }
    }

    function createDetailedDataView(data, level = 0) {
        if (level > 3) return '<span class="text-muted">Max nesting level reached...</span>';

        const indent = 'ps-' + (level * 3);

        return `
        <div class="${indent}">
            ${Object.entries(data).map(([key, value]) => {
            const valueType = Array.isArray(value) ? 'array' : typeof value;

            return `
                    <div class="mb-3 p-2 border-start border-2 border-light">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong class="text-primary">
                                <i class="${getColumnIcon({key, type: valueType})} me-2"></i>
                                ${formatColumnHeader({key})}
                            </strong>
                            <span class="badge bg-outline-secondary">${valueType}</span>
                        </div>
                        <div class="mt-2">
                            ${formatDetailedValue(value, key, level)}
                        </div>
                    </div>
                `;
        }).join('')}
        </div>
    `;
    }

    function createArrayView(data, parentKey) {
        if (data.length === 0) return '<div class="alert alert-info">Empty array</div>';

        // Check if array contains objects
        const firstItem = data[0];
        const isObjectArray = typeof firstItem === 'object' && !Array.isArray(firstItem);

        if (isObjectArray) {
            // Create table for array of objects
            const allKeys = [...new Set(data.flatMap(item => Object.keys(item || {})))];

            return `
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">#</th>
                            ${allKeys.map(key => `
                                <th scope="col">${formatColumnHeader({key})}</th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map((item, index) => `
                            <tr>
                                <td><span class="badge bg-secondary">${index + 1}</span></td>
                                ${allKeys.map(key => `
                                    <td>${formatCellValue(item[key], typeof item[key], key)}</td>
                                `).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        } else {
            // Simple list for primitive arrays
            return `
            <div class="row">
                ${data.map((item, index) => `
                    <div class="col-md-6 col-lg-4 mb-2">
                        <div class="card">
                            <div class="card-body py-2">
                                <small class="text-muted">[${index}]</small>
                                <div>${formatCellValue(item, typeof item, parentKey)}</div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        }
    }

    function createObjectView(data, parentKey) {
        return `
        <div class="row">
            ${Object.entries(data).map(([key, value]) => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="${getColumnIcon({key, type: typeof value})} me-2"></i>
                                ${formatColumnHeader({key})}
                            </h6>
                            <p class="card-text">
                                ${formatCellValue(value, typeof value, key)}
                            </p>
                            <small class="text-muted">${typeof value}</small>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    }

    function formatDetailedValue(value, key, level) {
        if (value === null || value === undefined) {
            return '<span class="text-muted fst-italic">null</span>';
        }

        if (Array.isArray(value)) {
            return `
            <div class="border rounded p-2 bg-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-info">${value.length} items</span>
                    <button class="btn btn-sm btn-outline-primary"
                            onclick="showArrayDetails('${key}', ${JSON.stringify(value).replace(/"/g, '&quot;')})">
                        <i class="fas fa-expand-alt me-1"></i>View Array
                    </button>
                </div>
                ${value.length > 0 ? `
                    <small class="text-muted">
                        Preview: ${JSON.stringify(value.slice(0, 2))}${value.length > 2 ? '...' : ''}
                    </small>
                ` : '<small class="text-muted">Empty array</small>'}
            </div>
        `;
        }

        if (typeof value === 'object') {
            const keys = Object.keys(value);
            return `
            <div class="border rounded p-2 bg-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-secondary">${keys.length} fields</span>
                    <button class="btn btn-sm btn-outline-primary"
                            onclick="showObjectDetails('${key}', ${JSON.stringify(value).replace(/"/g, '&quot;')})">
                        <i class="fas fa-expand-alt me-1"></i>View Object
                    </button>
                </div>
                ${keys.length > 0 ? `
                    <small class="text-muted">
                        Fields: ${keys.slice(0, 3).join(', ')}${keys.length > 3 ? '...' : ''}
                    </small>
                ` : '<small class="text-muted">Empty object</small>'}
            </div>
        `;
        }

        return `<div class="font-monospace">${formatCellValue(value, typeof value, key)}</div>`;
    }

    function exportModalData() {
        if (!window.currentModalData) {
            alert('No data to export');
            return;
        }

        const dataStr = JSON.stringify(window.currentModalData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `data-export-${new Date().toISOString().slice(0, 19)}.json`;
        link.click();

        URL.revokeObjectURL(link.href);
    }
</script>
</body>
</html>